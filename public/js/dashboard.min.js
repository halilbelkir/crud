$("#datePicker").daterangepicker({startDate:moment().startOf("month"),locale:{cancelLabel:"Vazgeç",applyLabel:"Filtrele",format:"DD.MM.YYYY"}});let chart=mixedChart();$(".drp-selected").text($("#chartDate").val());setTimeout(function(){$(".applyBtn").trigger("click")},200);$(".applyBtn").click(function(e){let target=document.querySelectorAll(".card");let datePicker=$("#datePicker");let formData=new FormData;let date=$(".drp-selected").text();let blockUI="";formData.append("date",date);$.each(target,function(i,item){if($(item).attr("id")!="monthNpsCard"){let oldBlockUI=KTBlockUI.getInstance(item);if(oldBlockUI){oldBlockUI.destroy()}blockUI=new KTBlockUI(item,{message:'<div class="blockui-message"><img style="height: 40px" src="/assets/images/loading.gif" alt=""></div>'});blockUI.block()}});$.ajaxSetup({headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")}});$.ajax({type:"POST",url:datePicker.data("action"),data:formData,dataType:"json",cache:false,contentType:false,processData:false,success:function(response){blockDestroy("#totalNpsCard .card");if(response.response){npsChart(response);dateFilterNpsCard(response);dateFilterCompletedCard(response);$("html,body").animate({scrollTop:$("#totalNpsCard").offset().top-110},400)}},error:function(response){blockDestroy("#totalNpsCard .card");if(response.responseJSON.message){messageAlert(0,response.responseJSON.message)}else{messageAlert(0,"İşlem Başarısız. Lütfen daha sonra tekrar deneyiniz.")}}})});function dateFilterNpsCard(response){let result=response.response;let selector="#dateFilterNps";$(selector).html("");$.each(result,function(i,item){if($(selector+"#"+i).length>0){$(selector+" #"+i+" .nps").text(item.nps);blockDestroy(selector+" #"+i+" .card")}else{let card='<div class="col-12 col-md-4 col-lg-3 col-xl-2 mb-15" id="'+i+'"><div class="card"><div class="card-header cursor-pointer"><div class="card-title m-0"><p class="fs-5 fw-bold text-hover-primary m-0">'+item.title+"  NPS (TP "+item.touch_point+') </p></div></div><div class="card-body"><div class="fs-2 nps fw-bold">'+parseFloat(item.nps).toFixed(2)+" %</div></div></div></div>";$(selector).append(card)}});let card='<div class="col-12 col-md-4 col-lg-3 col-xl-2 mb-15" id="dateFilterNpsAll"><div class="card"><div class="card-header cursor-pointer"><div class="card-title m-0"><p class="fs-5 fw-bold text-hover-primary m-0">Toplam  NPS  </p></div></div><div class="card-body"><div class="fs-2 nps fw-bold">'+parseFloat(response.npsTotal).toFixed(2)+" %</div></div></div></div>";$(selector).append(card)}function dateFilterCompletedCard(response){let result=response.completed;let selector="#completedNps";let card="";$(selector).html("");$.each(result,function(i,item){card='<a href="'+item.url+'" class="col-12 col-md-4 col-lg-4 mb-15" id="'+i+'"><div class="card"><div class="card-header cursor-pointer"><div class="card-title m-0"><p class="fs-5 fw-bold text-hover-primary m-0">'+item.title+' </p></div></div><div class="card-body"><div class="fs-2 nps fw-bold">'+item.answerCount+" Tamamlanma<br> <span>"+item.totalSMS+" SMS</span> <br> <span>"+item.totalEmail+" Email</span></div></div></div></a>";$(selector).append(card)});card='<div class="clear"></div>';card+='<div class="col-12 col-md-4 col-lg-4 mb-15" id="completedTotal"><div class="card"><div class="card-header cursor-pointer"><div class="card-title m-0"><p class="fs-5 fw-bold text-hover-primary m-0">Toplam Cevaplanma </p></div></div><div class="card-body"><div class="fs-2 nps fw-bold">'+response.completedTotal+"</div></div></div></div>";card+='<div class="col-12 col-md-4 col-lg-4 mb-15" id="allSMSCount"><div class="card"><div class="card-header cursor-pointer"><div class="card-title m-0"><p class="fs-5 fw-bold text-hover-primary m-0">Toplam SMS </p></div></div><div class="card-body"><div class="fs-2 nps fw-bold">'+response.allSMSCount+"</div></div></div></div>";card+='<div class="col-12 col-md-4 col-lg-4 mb-15" id="allEmailCount"><div class="card"><div class="card-header cursor-pointer"><div class="card-title m-0"><p class="fs-5 fw-bold text-hover-primary m-0">Toplam Email </p></div></div><div class="card-body"><div class="fs-2 nps fw-bold">'+response.allEmailCount+"</div></div></div></div>";$(selector).append(card)}function npsChart(response){let result=response.response;let promoter=[];let passive=[];let detractor=[];let surveysNps=[];$.each(result,function(i,item){promoter.push(parseFloat(item.promoterPercent).toFixed(2));passive.push(parseFloat(item.passivePercent).toFixed(2));detractor.push(parseFloat(item.detractorPercent).toFixed(2));surveysNps.push(parseFloat(item.nps).toFixed(2))});let promoterData={type:"bar",label:"Promoter Yüzdesi ",data:promoter,fill:false,borderColor:"#68B65B",backgroundColor:"#68B65B",barPercentage:"0.4",tension:.1};let passiveData={type:"bar",label:"Passive Yüzdesi ",data:passive,fill:false,borderColor:"#d9a036",backgroundColor:"#d9a036",barPercentage:"0.4",tension:.1};let detractorData={type:"bar",label:"Detractor Yüzdesi ",data:detractor,fill:false,borderColor:"#c21b17",backgroundColor:"#c21b17",barPercentage:"0.4",tension:.1};let npsRate={type:"line",label:"Total Nps",data:surveysNps,borderColor:"#20252b",backgroundColor:"#20252b",pointStyle:"circle"};let datasets=[npsRate,promoterData,passiveData,detractorData];chart.destroy();chart=mixedChart(response.labels,datasets)}function mixedChart(labels=null,datasets=null){var ctx=document.getElementById("totalNpsChart");const data={labels:labels,datasets:datasets};const config={data:data,options:{plugins:{title:{display:false}},scales:{x:{stacked:true},y:{stacked:true}},responsive:true}};return new Chart(ctx,config)}function blockDestroy(selector){selector=document.querySelector(selector);KTBlockUI.getInstance(selector).release();KTBlockUI.getInstance(selector).destroy()}